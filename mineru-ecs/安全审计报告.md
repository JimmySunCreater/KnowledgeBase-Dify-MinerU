# MinerU ECS å®‰å…¨å®¡è®¡æŠ¥å‘Š

## ğŸ”’ å®¡è®¡ç»“æœï¼šâœ… é€šè¿‡

**å®¡è®¡æ—¶é—´**: 2025-01-27  
**å®¡è®¡èŒƒå›´**: æ‰€æœ‰ä»£ç æ–‡ä»¶ã€é…ç½®æ–‡ä»¶ã€éƒ¨ç½²è„šæœ¬  
**å®¡è®¡ç›®æ ‡**: æ£€æŸ¥ç¡¬ç¼–ç çš„ AKSKã€è´¦å· IDã€æ•æ„Ÿä¿¡æ¯

---

## âœ… å®¡è®¡ç»“è®º

**é¡¹ç›®ä»£ç ä¸­æ²¡æœ‰ç¡¬ç¼–ç çš„æ•æ„Ÿä¿¡æ¯ï¼Œå¯ä»¥å®‰å…¨åœ°åœ¨å…¶ä»– AWS è´¦å·éƒ¨ç½²ã€‚**

---

## ğŸ“Š è¯¦ç»†å®¡è®¡ç»“æœ

### 1. AWS å‡­è¯ (AKSK)

#### âœ… æ£€æŸ¥ç»“æœï¼šå®‰å…¨

**æ£€æŸ¥é¡¹**:
- AWS Access Key ID
- AWS Secret Access Key
- AWS Session Token

**å‘ç°**:
```yaml
# docker/docker-compose.yml (ä»…ç”¨äºæœ¬åœ°æµ‹è¯•)
environment:
  - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}          # âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡
  - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}  # âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡
  - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}          # âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡
```

**ç»“è®º**: 
- âœ… æ‰€æœ‰å‡­è¯éƒ½é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’
- âœ… æ²¡æœ‰ç¡¬ç¼–ç çš„ AKSK
- âœ… docker-compose.yml ä»…ç”¨äºæœ¬åœ°å¼€å‘æµ‹è¯•

---

### 2. AWS è´¦å· ID

#### âœ… æ£€æŸ¥ç»“æœï¼šå®‰å…¨

**æ£€æŸ¥é¡¹**:
- 12 ä½è´¦å· ID
- ARN ä¸­çš„è´¦å· ID
- èµ„æºåç§°ä¸­çš„è´¦å· ID

**å‘ç°**:
æ‰€æœ‰è´¦å· ID éƒ½ä½¿ç”¨ CloudFormation å†…ç½®å˜é‡ `${AWS::AccountId}`ï¼š

```yaml
# 02-ecs-data-services.yaml
BucketName: !Sub '${ProjectName}-${Environment}-data-${AWS::AccountId}'
# âœ… åŠ¨æ€è·å–å½“å‰è´¦å· ID

# 04-ecs-compute-services.yaml
Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/ecs/${ProjectName}-${Environment}*'
# âœ… åŠ¨æ€è·å–å½“å‰è´¦å· ID

Resource: !Sub 'arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:${ProjectName}-${Environment}-processing-queue'
# âœ… åŠ¨æ€è·å–å½“å‰è´¦å· ID

Resource: !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ProjectName}-${Environment}-processing-jobs'
# âœ… åŠ¨æ€è·å–å½“å‰è´¦å· ID
```

**ç»“è®º**:
- âœ… æ²¡æœ‰ç¡¬ç¼–ç çš„è´¦å· ID
- âœ… æ‰€æœ‰è´¦å· ID éƒ½åŠ¨æ€è·å–
- âœ… å¯ä»¥åœ¨ä»»ä½• AWS è´¦å·éƒ¨ç½²

---

### 3. AWS Region

#### âœ… æ£€æŸ¥ç»“æœï¼šå®‰å…¨

**æ£€æŸ¥é¡¹**:
- ç¡¬ç¼–ç çš„ region
- ä»£ç ä¸­çš„ region é…ç½®

**å‘ç°**:

**Python ä»£ç **:
```python
# æ‰€æœ‰ Python ä»£ç éƒ½ä»ç¯å¢ƒå˜é‡è¯»å– region
AWS_REGION = os.getenv('AWS_REGION', 'us-east-1')  # âœ… ç¯å¢ƒå˜é‡ + é»˜è®¤å€¼
```

**CloudFormation æ¨¡æ¿**:
```yaml
# ä½¿ç”¨å†…ç½®å˜é‡
Region: !Ref AWS::Region  # âœ… åŠ¨æ€è·å–å½“å‰ region
```

**é…ç½®æ–‡ä»¶**:
```yaml
# config.yaml
default:
  aws_region: us-east-1  # âœ… å¯é…ç½®ï¼Œéç¡¬ç¼–ç 
```

**docker-compose.yml**:
```yaml
# ä»…ç”¨äºæœ¬åœ°æµ‹è¯•
- AWS_DEFAULT_REGION=us-east-1  # âš ï¸ æœ¬åœ°æµ‹è¯•é»˜è®¤å€¼
```

**ç»“è®º**:
- âœ… ç”Ÿäº§ç¯å¢ƒæ²¡æœ‰ç¡¬ç¼–ç  region
- âœ… é€šè¿‡ config.yaml é…ç½®
- âš ï¸ docker-compose.yml ä¸­çš„ us-east-1 ä»…ç”¨äºæœ¬åœ°æµ‹è¯•

---

### 4. èµ„æºåç§°

#### âœ… æ£€æŸ¥ç»“æœï¼šå®‰å…¨

**æ£€æŸ¥é¡¹**:
- S3 Bucket åç§°
- DynamoDB è¡¨å
- SQS é˜Ÿåˆ—åç§°
- ECS é›†ç¾¤åç§°

**å‘ç°**:
æ‰€æœ‰èµ„æºåç§°éƒ½ä½¿ç”¨å‚æ•°åŒ–å‘½åï¼š

```yaml
# å‘½åæ¨¡å¼ï¼š${ProjectName}-${Environment}-{resource-type}-${AWS::AccountId}

S3 Bucket:
  !Sub '${ProjectName}-${Environment}-data-${AWS::AccountId}'
  # ç¤ºä¾‹: mineru-ecs-production-data-123456789012

DynamoDB Table:
  !Sub '${ProjectName}-${Environment}-processing-jobs'
  # ç¤ºä¾‹: mineru-ecs-production-processing-jobs

SQS Queue:
  !Sub '${ProjectName}-${Environment}-processing-queue'
  # ç¤ºä¾‹: mineru-ecs-production-processing-queue

ECS Cluster:
  !Sub '${ProjectName}-${Environment}-cluster'
  # ç¤ºä¾‹: mineru-ecs-production-cluster
```

**ç»“è®º**:
- âœ… æ‰€æœ‰èµ„æºåç§°éƒ½å‚æ•°åŒ–
- âœ… é€šè¿‡ ProjectName å’Œ Environment å‚æ•°æ§åˆ¶
- âœ… ä¸åŒè´¦å·éƒ¨ç½²ä¸ä¼šå†²çª

---

### 5. IAM è§’è‰²å’Œç­–ç•¥

#### âœ… æ£€æŸ¥ç»“æœï¼šå®‰å…¨

**æ£€æŸ¥é¡¹**:
- ç¡¬ç¼–ç çš„ IAM è§’è‰² ARN
- ç¡¬ç¼–ç çš„ç­–ç•¥ ARN

**å‘ç°**:
```yaml
# æ‰€æœ‰ IAM èµ„æºéƒ½åŠ¨æ€åˆ›å»º
ECSTaskRole:
  Type: AWS::IAM::Role
  Properties:
    RoleName: !Sub '${ProjectName}-${Environment}-task-role'  # âœ… å‚æ•°åŒ–
    AssumeRolePolicyDocument: ...

ECSTaskExecutionRole:
  Type: AWS::IAM::Role
  Properties:
    RoleName: !Sub '${ProjectName}-${Environment}-task-execution-role'  # âœ… å‚æ•°åŒ–
    ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy  # âœ… AWS æ‰˜ç®¡ç­–ç•¥
```

**ç»“è®º**:
- âœ… æ²¡æœ‰ç¡¬ç¼–ç çš„ IAM è§’è‰²
- âœ… æ‰€æœ‰è§’è‰²éƒ½åœ¨éƒ¨ç½²æ—¶åˆ›å»º
- âœ… ä½¿ç”¨ AWS æ‰˜ç®¡ç­–ç•¥

---

### 6. å®¹å™¨é•œåƒ

#### âœ… æ£€æŸ¥ç»“æœï¼šå®‰å…¨

**æ£€æŸ¥é¡¹**:
- ç¡¬ç¼–ç çš„ ECR ä»“åº“
- ç§æœ‰é•œåƒä»“åº“å‡­è¯

**å‘ç°**:
```yaml
# config.yaml
container_image: public.ecr.aws/b1v8r5t6/mineru-ecs-gpu:latest  # âœ… å…¬å…±é•œåƒ
```

**ç»“è®º**:
- âœ… ä½¿ç”¨å…¬å…± ECR é•œåƒ
- âœ… æ— éœ€é¢å¤–å‡­è¯
- âœ… å¯é…ç½®ä¸ºç§æœ‰é•œåƒä»“åº“

---

### 7. éƒ¨ç½²è„šæœ¬

#### âœ… æ£€æŸ¥ç»“æœï¼šå®‰å…¨

**æ£€æŸ¥é¡¹**:
- ç¡¬ç¼–ç çš„è´¦å·ä¿¡æ¯
- ç¡¬ç¼–ç çš„å‡­è¯

**å‘ç°**:
```bash
# deploy-cross-account.sh

# åŠ¨æ€è·å–è´¦å· ID
get_account_id() {
    if [ -n "$AWS_PROFILE" ]; then
        aws sts get-caller-identity --profile "$AWS_PROFILE" --query Account --output text
    else
        aws sts get-caller-identity --query Account --output text
    fi
}
# âœ… ä» AWS CLI åŠ¨æ€è·å–

# ä»é…ç½®æ–‡ä»¶è¯»å–å‚æ•°
get_config_value() {
    local key=$1
    local account_id=$2
    local env=$3
    # ä» config.yaml è¯»å–é…ç½®
}
# âœ… å‚æ•°åŒ–é…ç½®
```

**ç»“è®º**:
- âœ… æ²¡æœ‰ç¡¬ç¼–ç çš„è´¦å·ä¿¡æ¯
- âœ… æ”¯æŒå¤šè´¦å·éƒ¨ç½²
- âœ… é€šè¿‡ AWS CLI è·å–å½“å‰è´¦å·

---

## ğŸ¯ è·¨è´¦å·éƒ¨ç½²æŒ‡å—

### æ–¹æ³• 1: ä½¿ç”¨ä¸åŒçš„ AWS Profile

```bash
# è´¦å· A éƒ¨ç½²
aws configure --profile account-a
./deploy-cross-account.sh --environment production --profile account-a

# è´¦å· B éƒ¨ç½²
aws configure --profile account-b
./deploy-cross-account.sh --environment production --profile account-b
```

### æ–¹æ³• 2: ä½¿ç”¨ç¯å¢ƒå˜é‡

```bash
# è´¦å· A éƒ¨ç½²
export AWS_ACCESS_KEY_ID=AKIA...
export AWS_SECRET_ACCESS_KEY=...
export AWS_DEFAULT_REGION=us-east-1
./deploy-cross-account.sh --environment production

# è´¦å· B éƒ¨ç½²
export AWS_ACCESS_KEY_ID=AKIA...
export AWS_SECRET_ACCESS_KEY=...
export AWS_DEFAULT_REGION=us-west-2
./deploy-cross-account.sh --environment production --region us-west-2
```

### æ–¹æ³• 3: ä½¿ç”¨ IAM Role (æ¨è)

```bash
# åœ¨è´¦å· A ä¸­åˆ›å»º IAM Role
# å…è®¸è´¦å· B çš„ç”¨æˆ· assume è¯¥ role

# è´¦å· B ç”¨æˆ·éƒ¨ç½²åˆ°è´¦å· A
aws sts assume-role \
  --role-arn arn:aws:iam::ACCOUNT_A_ID:role/DeploymentRole \
  --role-session-name deployment-session

# ä½¿ç”¨ä¸´æ—¶å‡­è¯éƒ¨ç½²
./deploy-cross-account.sh --environment production
```

---

## ğŸ“ é…ç½®æ–‡ä»¶è¯´æ˜

### config.yaml - å¯é…ç½®é¡¹

```yaml
# æ‰€æœ‰é…ç½®éƒ½å¯ä»¥ä¿®æ”¹ï¼Œæ²¡æœ‰ç¡¬ç¼–ç 
default:
  project_name: mineru-ecs        # âœ… å¯ä¿®æ”¹
  environment: production         # âœ… å¯ä¿®æ”¹
  aws_region: us-east-1          # âœ… å¯ä¿®æ”¹
  instance_type: g4dn.xlarge     # âœ… å¯ä¿®æ”¹
  container_image: public.ecr.aws/b1v8r5t6/mineru-ecs-gpu:latest  # âœ… å¯ä¿®æ”¹

# æ”¯æŒå¤šç¯å¢ƒé…ç½®
development:
  environment: development
  aws_region: us-west-2          # âœ… ä¸åŒ region

production:
  environment: production
  aws_region: us-east-1          # âœ… ä¸åŒ region
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. docker-compose.yml

**ä½ç½®**: `docker/docker-compose.yml`

**ç”¨é€”**: ä»…ç”¨äºæœ¬åœ°å¼€å‘æµ‹è¯•

**åŒ…å«çš„é»˜è®¤å€¼**:
```yaml
- AWS_DEFAULT_REGION=us-east-1  # æœ¬åœ°æµ‹è¯•é»˜è®¤å€¼
- QUEUE_URL=${QUEUE_URL:-https://sqs.us-east-1.amazonaws.com/YOUR_ACCOUNT_ID/...}
```

**è¯´æ˜**:
- âš ï¸ è¿™äº›æ˜¯æœ¬åœ°æµ‹è¯•çš„å ä½ç¬¦
- âš ï¸ ç”Ÿäº§ç¯å¢ƒä¸ä½¿ç”¨ docker-compose.yml
- âœ… ç”Ÿäº§ç¯å¢ƒé€šè¿‡ ECS ä»»åŠ¡å®šä¹‰ä¼ é€’ç¯å¢ƒå˜é‡

### 2. å®¹å™¨é•œåƒ

**å½“å‰é…ç½®**:
```yaml
container_image: public.ecr.aws/b1v8r5t6/mineru-ecs-gpu:latest
```

**å¦‚æœä½¿ç”¨ç§æœ‰é•œåƒ**:
```yaml
# ä¿®æ”¹ä¸ºä½ çš„ç§æœ‰ ECR
container_image: 123456789012.dkr.ecr.us-east-1.amazonaws.com/mineru-ecs:latest

# ç¡®ä¿ ECS ä»»åŠ¡æ‰§è¡Œè§’è‰²æœ‰æƒé™æ‹‰å–é•œåƒ
```

---

## âœ… å®‰å…¨æœ€ä½³å®è·µ

### å·²å®æ–½çš„å®‰å…¨æªæ–½

1. âœ… **æ— ç¡¬ç¼–ç å‡­è¯** - æ‰€æœ‰å‡­è¯é€šè¿‡ IAM è§’è‰²æˆ–ç¯å¢ƒå˜é‡
2. âœ… **å‚æ•°åŒ–é…ç½®** - æ‰€æœ‰èµ„æºåç§°éƒ½å‚æ•°åŒ–
3. âœ… **åŠ¨æ€è´¦å· ID** - ä½¿ç”¨ CloudFormation å†…ç½®å˜é‡
4. âœ… **IAM æœ€å°æƒé™** - æ¯ä¸ªè§’è‰²åªæœ‰å¿…éœ€çš„æƒé™
5. âœ… **åŠ å¯†ä¼ è¾“** - æ‰€æœ‰ AWS æœåŠ¡é€šä¿¡ä½¿ç”¨ HTTPS
6. âœ… **åŠ å¯†å­˜å‚¨** - S3 å’Œ DynamoDB å¯ç”¨åŠ å¯†
7. âœ… **VPC éš”ç¦»** - ECS ä»»åŠ¡è¿è¡Œåœ¨ç§æœ‰å­ç½‘

### å»ºè®®çš„é¢å¤–æªæ–½

1. ğŸ“ **ä½¿ç”¨ AWS Secrets Manager** å­˜å‚¨æ•æ„Ÿé…ç½®
2. ğŸ“ **å¯ç”¨ CloudTrail** å®¡è®¡æ‰€æœ‰ API è°ƒç”¨
3. ğŸ“ **é…ç½® AWS Config** ç›‘æ§èµ„æºåˆè§„æ€§
4. ğŸ“ **ä½¿ç”¨ AWS Organizations** ç®¡ç†å¤šè´¦å·
5. ğŸ“ **å®šæœŸè½®æ¢ IAM å‡­è¯**

---

## ğŸ” éªŒè¯æ¸…å•

åœ¨æ–°è´¦å·éƒ¨ç½²å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] AWS CLI å·²é…ç½®æ­£ç¡®çš„å‡­è¯
- [ ] è´¦å·æœ‰è¶³å¤Ÿçš„æœåŠ¡é™é¢ï¼ˆECSã€EC2ã€S3 ç­‰ï¼‰
- [ ] ä¿®æ”¹ `config.yaml` ä¸­çš„ `project_name`ï¼ˆé¿å…å†²çªï¼‰
- [ ] é€‰æ‹©åˆé€‚çš„ `aws_region`
- [ ] ç¡®è®¤ `container_image` å¯è®¿é—®
- [ ] æ£€æŸ¥ IAM æƒé™æ˜¯å¦è¶³å¤Ÿ

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰å®‰å…¨ç›¸å…³é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- é¡¹ç›®ç»´æŠ¤è€…
- AWS å®‰å…¨å›¢é˜Ÿ

---

**å®¡è®¡äººå‘˜**: AI Assistant  
**å®¡è®¡æ—¥æœŸ**: 2025-01-27  
**å®¡è®¡ç‰ˆæœ¬**: v1.0  
**ä¸‹æ¬¡å®¡è®¡**: å»ºè®®æ¯å­£åº¦å®¡è®¡ä¸€æ¬¡
