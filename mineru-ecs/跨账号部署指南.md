# MinerU ECS è·¨è´¦å·éƒ¨ç½²æŒ‡å—

## âœ… å®‰å…¨ç¡®è®¤

**é¡¹ç›®ä»£ç ä¸­æ²¡æœ‰ç¡¬ç¼–ç çš„ AKSKã€è´¦å· ID ç­‰æ•æ„Ÿä¿¡æ¯ï¼Œå¯ä»¥å®‰å…¨åœ°åœ¨ä»»ä½• AWS è´¦å·éƒ¨ç½²ã€‚**

è¯¦ç»†å®‰å…¨å®¡è®¡æŠ¥å‘Šè¯·æŸ¥çœ‹ï¼š[å®‰å…¨å®¡è®¡æŠ¥å‘Š.md](./å®‰å…¨å®¡è®¡æŠ¥å‘Š.md)

---

## ðŸš€ å¿«é€Ÿéƒ¨ç½²åˆ°æ–°è´¦å·

### æ–¹æ³• 1: ä½¿ç”¨ AWS Profileï¼ˆæŽ¨èï¼‰

#### æ­¥éª¤ 1: é…ç½®æ–°è´¦å·çš„ AWS Profile

```bash
# é…ç½®æ–°è´¦å·çš„å‡­è¯
aws configure --profile new-account

# è¾“å…¥ä»¥ä¸‹ä¿¡æ¯ï¼š
# AWS Access Key ID: AKIA...
# AWS Secret Access Key: ...
# Default region name: us-east-1
# Default output format: json

# éªŒè¯é…ç½®
aws sts get-caller-identity --profile new-account
```

#### æ­¥éª¤ 2: ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

```bash
cd /home/ubuntu/efs/mineru-ecs

# å¤åˆ¶é…ç½®æ–‡ä»¶
cp config.yaml config-new-account.yaml

# ç¼–è¾‘é…ç½®ï¼ˆå¯é€‰ï¼Œä½¿ç”¨é»˜è®¤é…ç½®ä¹Ÿå¯ä»¥ï¼‰
vim config-new-account.yaml
```

**å»ºè®®ä¿®æ”¹çš„é…ç½®**:
```yaml
production:
  project_name: mineru-ecs-new     # ä¿®æ”¹é¡¹ç›®åé¿å…å†²çª
  environment: production
  aws_region: us-east-1            # é€‰æ‹©ä½ çš„ region
  instance_type: g4dn.xlarge
  min_size: 1
  max_size: 2
  desired_capacity: 1
```

#### æ­¥éª¤ 3: æ‰§è¡Œéƒ¨ç½²

```bash
# ä½¿ç”¨æ–°è´¦å·çš„ profile éƒ¨ç½²
./deploy-cross-account.sh \
  --environment production \
  --region us-east-1 \
  --profile new-account

# æˆ–è€…ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
CONFIG_FILE=config-new-account.yaml \
./deploy-cross-account.sh \
  --environment production \
  --profile new-account
```

#### æ­¥éª¤ 4: éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥ CloudFormation æ ˆ
aws cloudformation list-stacks \
  --profile new-account \
  --region us-east-1 \
  --query 'StackSummaries[?contains(StackName, `mineru-ecs`)].{Name:StackName,Status:StackStatus}'

# æ£€æŸ¥ ECS é›†ç¾¤
aws ecs describe-clusters \
  --clusters mineru-ecs-production-cluster \
  --profile new-account \
  --region us-east-1

# æ£€æŸ¥è¿è¡Œä¸­çš„ä»»åŠ¡
aws ecs list-tasks \
  --cluster mineru-ecs-production-cluster \
  --profile new-account \
  --region us-east-1
```

---

### æ–¹æ³• 2: ä½¿ç”¨çŽ¯å¢ƒå˜é‡

#### æ­¥éª¤ 1: è®¾ç½®çŽ¯å¢ƒå˜é‡

```bash
# è®¾ç½®æ–°è´¦å·çš„å‡­è¯
export AWS_ACCESS_KEY_ID=AKIA...
export AWS_SECRET_ACCESS_KEY=...
export AWS_DEFAULT_REGION=us-east-1

# éªŒè¯é…ç½®
aws sts get-caller-identity
```

#### æ­¥éª¤ 2: æ‰§è¡Œéƒ¨ç½²

```bash
cd /home/ubuntu/efs/mineru-ecs

# ç›´æŽ¥éƒ¨ç½²
./deploy-cross-account.sh --environment production --region us-east-1
```

#### æ­¥éª¤ 3: æ¸…ç†çŽ¯å¢ƒå˜é‡ï¼ˆå®‰å…¨ï¼‰

```bash
# éƒ¨ç½²å®ŒæˆåŽæ¸…ç†å‡­è¯
unset AWS_ACCESS_KEY_ID
unset AWS_SECRET_ACCESS_KEY
unset AWS_DEFAULT_REGION
```

---

### æ–¹æ³• 3: ä½¿ç”¨ IAM Roleï¼ˆä¼ä¸šæŽ¨èï¼‰

#### åœºæ™¯ï¼šä»Žè´¦å· B éƒ¨ç½²åˆ°è´¦å· A

#### æ­¥éª¤ 1: åœ¨è´¦å· A åˆ›å»º IAM Role

```bash
# åœ¨è´¦å· A ä¸­åˆ›å»ºä¿¡ä»»ç­–ç•¥
cat > trust-policy.json <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::ACCOUNT_B_ID:root"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
EOF

# åˆ›å»º Role
aws iam create-role \
  --role-name MinerUDeploymentRole \
  --assume-role-policy-document file://trust-policy.json \
  --profile account-a

# é™„åŠ å¿…è¦çš„æƒé™ç­–ç•¥
aws iam attach-role-policy \
  --role-name MinerUDeploymentRole \
  --policy-arn arn:aws:iam::aws:policy/PowerUserAccess \
  --profile account-a
```

#### æ­¥éª¤ 2: åœ¨è´¦å· B ä¸­ Assume Role

```bash
# ä»Žè´¦å· B assume è´¦å· A çš„ role
aws sts assume-role \
  --role-arn arn:aws:iam::ACCOUNT_A_ID:role/MinerUDeploymentRole \
  --role-session-name mineru-deployment \
  --profile account-b

# è¾“å‡ºä¼šåŒ…å«ä¸´æ—¶å‡­è¯ï¼š
# - AccessKeyId
# - SecretAccessKey
# - SessionToken
```

#### æ­¥éª¤ 3: ä½¿ç”¨ä¸´æ—¶å‡­è¯éƒ¨ç½²

```bash
# è®¾ç½®ä¸´æ—¶å‡­è¯
export AWS_ACCESS_KEY_ID=ASIA...
export AWS_SECRET_ACCESS_KEY=...
export AWS_SESSION_TOKEN=...

# æ‰§è¡Œéƒ¨ç½²
cd /home/ubuntu/efs/mineru-ecs
./deploy-cross-account.sh --environment production --region us-east-1
```

---

## ðŸŒ å¤š Region éƒ¨ç½²

### åœ¨ä¸åŒ Region éƒ¨ç½²

```bash
# éƒ¨ç½²åˆ° us-east-1
./deploy-cross-account.sh \
  --environment production \
  --region us-east-1 \
  --profile new-account

# éƒ¨ç½²åˆ° us-west-2
./deploy-cross-account.sh \
  --environment production \
  --region us-west-2 \
  --profile new-account

# éƒ¨ç½²åˆ° eu-west-1
./deploy-cross-account.sh \
  --environment production \
  --region eu-west-1 \
  --profile new-account
```

**æ³¨æ„äº‹é¡¹**:
- æ¯ä¸ª region ä¼šåˆ›å»ºç‹¬ç«‹çš„èµ„æº
- S3 bucket åç§°ä¼šè‡ªåŠ¨åŒ…å« region ä¿¡æ¯
- ç¡®ä¿é€‰æ‹©çš„ region æ”¯æŒ g4dn å®žä¾‹

---

## ðŸ”§ é…ç½®è‡ªå®šä¹‰

### 1. ä¿®æ”¹é¡¹ç›®åç§°

```yaml
# config.yaml
production:
  project_name: my-company-mineru  # è‡ªå®šä¹‰é¡¹ç›®å
```

**å½±å“çš„èµ„æºåç§°**:
- S3 Bucket: `my-company-mineru-production-data-{account-id}`
- DynamoDB: `my-company-mineru-production-processing-jobs`
- ECS Cluster: `my-company-mineru-production-cluster`

### 2. ä¿®æ”¹å®žä¾‹ç±»åž‹

```yaml
# config.yaml
production:
  instance_type: g4dn.2xlarge  # æ›´å¤§çš„ GPU å®žä¾‹
  task_cpu: 4096               # 4 vCPU
  task_memory: 16384           # 16 GB RAM
```

### 3. ä¿®æ”¹æ‰©ç¼©å®¹é…ç½®

```yaml
# config.yaml
production:
  min_size: 0          # æŒ‰éœ€å¯åŠ¨ï¼ŒèŠ‚çœæˆæœ¬
  max_size: 5          # æ”¯æŒæ›´é«˜å¹¶å‘
  desired_capacity: 0  # é»˜è®¤ä¸è¿è¡Œ
```

### 4. ä½¿ç”¨ç§æœ‰å®¹å™¨é•œåƒ

```yaml
# config.yaml
production:
  container_image: 123456789012.dkr.ecr.us-east-1.amazonaws.com/mineru-ecs:v1.0
```

**å‰ææ¡ä»¶**:
- åœ¨ç›®æ ‡è´¦å·çš„ ECR ä¸­æŽ¨é€é•œåƒ
- ECS ä»»åŠ¡æ‰§è¡Œè§’è‰²æœ‰æƒé™æ‹‰å–é•œåƒ

---

## âœ… éƒ¨ç½²éªŒè¯æ¸…å•

### éƒ¨ç½²å‰æ£€æŸ¥

- [ ] AWS CLI å·²å®‰è£…å¹¶é…ç½®
- [ ] ç›®æ ‡è´¦å·å‡­è¯å·²é…ç½®
- [ ] ç¡®è®¤è´¦å·æœ‰è¶³å¤Ÿçš„æœåŠ¡é™é¢
  - ECS é›†ç¾¤æ•°é‡
  - EC2 å®žä¾‹æ•°é‡ï¼ˆg4dn.xlargeï¼‰
  - S3 å­˜å‚¨æ¡¶æ•°é‡
  - DynamoDB è¡¨æ•°é‡
- [ ] é€‰æ‹©çš„ region æ”¯æŒ g4dn å®žä¾‹
- [ ] ä¿®æ”¹äº† `project_name`ï¼ˆå¦‚æžœéœ€è¦ï¼‰
- [ ] ç¡®è®¤å®¹å™¨é•œåƒå¯è®¿é—®

### éƒ¨ç½²åŽéªŒè¯

```bash
# 1. æ£€æŸ¥æ‰€æœ‰ CloudFormation æ ˆ
aws cloudformation list-stacks \
  --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
  --query 'StackSummaries[?contains(StackName, `mineru-ecs`)].{Name:StackName,Status:StackStatus}' \
  --profile new-account

# åº”è¯¥çœ‹åˆ° 4 ä¸ªæ ˆï¼š
# - mineru-ecs-production-infrastructure
# - mineru-ecs-production-data-services
# - mineru-ecs-production-trigger-services
# - mineru-ecs-production-compute-services

# 2. æ£€æŸ¥ ECS é›†ç¾¤çŠ¶æ€
aws ecs describe-clusters \
  --clusters mineru-ecs-production-cluster \
  --profile new-account \
  --query 'clusters[0].{Status:status,RunningTasks:runningTasksCount,RegisteredInstances:registeredContainerInstancesCount}'

# 3. æ£€æŸ¥ Auto Scaling ç»„
aws autoscaling describe-auto-scaling-groups \
  --auto-scaling-group-names mineru-ecs-production-asg \
  --profile new-account \
  --query 'AutoScalingGroups[0].{DesiredCapacity:DesiredCapacity,Instances:length(Instances)}'

# 4. æ£€æŸ¥ S3 å­˜å‚¨æ¡¶
aws s3 ls --profile new-account | grep mineru-ecs

# 5. æ£€æŸ¥ DynamoDB è¡¨
aws dynamodb list-tables \
  --profile new-account \
  --query 'TableNames[?contains(@, `mineru-ecs`)]'

# 6. æ£€æŸ¥ SQS é˜Ÿåˆ—
aws sqs list-queues \
  --profile new-account \
  --query 'QueueUrls[?contains(@, `mineru-ecs`)]'
```

### åŠŸèƒ½æµ‹è¯•

```bash
# 1. ä¸Šä¼ æµ‹è¯• PDF
aws s3 cp test.pdf s3://mineru-ecs-production-data-{account-id}/input/ \
  --profile new-account

# 2. ç­‰å¾… 1-2 åˆ†é’Ÿï¼ŒæŸ¥çœ‹ä»»åŠ¡çŠ¶æ€
aws dynamodb scan \
  --table-name mineru-ecs-production-processing-jobs \
  --profile new-account \
  --limit 1

# 3. æŸ¥çœ‹å¤„ç†ç»“æžœ
aws s3 ls s3://mineru-ecs-production-data-{account-id}/processed/ \
  --recursive \
  --profile new-account

# 4. ä¸‹è½½ç»“æžœ
aws s3 sync s3://mineru-ecs-production-data-{account-id}/processed/{job-id}/ ./results/ \
  --profile new-account
```

---

## ðŸ—‘ï¸ æ¸…ç†èµ„æº

### åˆ é™¤éƒ¨ç½²

```bash
# æŒ‰ç›¸åé¡ºåºåˆ é™¤æ ˆ
aws cloudformation delete-stack \
  --stack-name mineru-ecs-production-compute-services \
  --profile new-account

aws cloudformation delete-stack \
  --stack-name mineru-ecs-production-trigger-services \
  --profile new-account

aws cloudformation delete-stack \
  --stack-name mineru-ecs-production-data-services \
  --profile new-account

aws cloudformation delete-stack \
  --stack-name mineru-ecs-production-infrastructure \
  --profile new-account

# æˆ–ä½¿ç”¨éƒ¨ç½²è„šæœ¬çš„æ¸…ç†åŠŸèƒ½
./deploy-cross-account.sh --environment production --profile new-account --delete
```

### æ‰‹åŠ¨æ¸…ç†ï¼ˆå¦‚æžœè‡ªåŠ¨åˆ é™¤å¤±è´¥ï¼‰

```bash
# 1. æ¸…ç©º S3 å­˜å‚¨æ¡¶
aws s3 rm s3://mineru-ecs-production-data-{account-id}/ \
  --recursive \
  --profile new-account

# 2. åˆ é™¤ S3 å­˜å‚¨æ¡¶
aws s3 rb s3://mineru-ecs-production-data-{account-id}/ \
  --profile new-account

# 3. åˆ é™¤ DynamoDB è¡¨
aws dynamodb delete-table \
  --table-name mineru-ecs-production-processing-jobs \
  --profile new-account

# 4. æ¸…ç©º SQS é˜Ÿåˆ—
aws sqs purge-queue \
  --queue-url https://sqs.us-east-1.amazonaws.com/{account-id}/mineru-ecs-production-processing-queue \
  --profile new-account

# 5. åˆ é™¤ CloudFormation æ ˆ
# ï¼ˆæŒ‰ä¸Šé¢çš„é¡ºåºï¼‰
```

---

## ðŸ’° æˆæœ¬ä¼°ç®—

### ä¸åŒè´¦å·çš„æˆæœ¬

**æˆæœ¬ä¸Žè´¦å·æ— å…³ï¼Œä»…ä¸Žèµ„æºä½¿ç”¨ç›¸å…³**:

| èµ„æº | é…ç½® | æœˆæˆæœ¬ï¼ˆä¼°ç®—ï¼‰ |
|------|------|---------------|
| **GPU å®žä¾‹** | g4dn.xlarge, 24å°æ—¶è¿è¡Œ | $378 |
| **EBS å­˜å‚¨** | 100GB gp3 | $10 |
| **S3 å­˜å‚¨** | æŒ‰å®žé™…ä½¿ç”¨ | $0.023/GB |
| **DynamoDB** | æŒ‰éœ€è®¡è´¹ | < $5 |
| **æ•°æ®ä¼ è¾“** | æŒ‰å®žé™…ä½¿ç”¨ | å˜åŠ¨ |
| **æ€»è®¡** | æŒç»­è¿è¡Œæ¨¡å¼ | ~$393/æœˆ |

**èŠ‚çœæˆæœ¬çš„é…ç½®**:
```yaml
# æŒ‰éœ€å¯åŠ¨æ¨¡å¼
min_size: 0
desired_capacity: 0
# æœˆæˆæœ¬: ~$42ï¼ˆä»…å¤„ç†æ—¶é—´ï¼‰
```

---

## ðŸ“ž å¸¸è§é—®é¢˜

### Q1: å¯ä»¥åœ¨å¤šä¸ªè´¦å·åŒæ—¶éƒ¨ç½²å—ï¼Ÿ

**ç­”**: å¯ä»¥ã€‚æ¯ä¸ªè´¦å·çš„èµ„æºå®Œå…¨ç‹¬ç«‹ï¼Œä¸ä¼šå†²çªã€‚

### Q2: ä¸åŒè´¦å·çš„èµ„æºåç§°ä¼šå†²çªå—ï¼Ÿ

**ç­”**: ä¸ä¼šã€‚èµ„æºåç§°åŒ…å«è´¦å· IDï¼Œè‡ªåŠ¨éš”ç¦»ã€‚

ç¤ºä¾‹ï¼š
- è´¦å· A: `mineru-ecs-production-data-111111111111`
- è´¦å· B: `mineru-ecs-production-data-222222222222`

### Q3: å¯ä»¥åœ¨åŒä¸€è´¦å·çš„ä¸åŒ region éƒ¨ç½²å—ï¼Ÿ

**ç­”**: å¯ä»¥ã€‚æ¯ä¸ª region çš„èµ„æºå®Œå…¨ç‹¬ç«‹ã€‚

### Q4: éœ€è¦ä¿®æ”¹ä»£ç å—ï¼Ÿ

**ç­”**: ä¸éœ€è¦ã€‚ä»£ç å·²ç»å®Œå…¨å‚æ•°åŒ–ï¼Œæ— éœ€ä¿®æ”¹ã€‚

### Q5: å¦‚ä½•åœ¨æ–°è´¦å·ä½¿ç”¨ä¸åŒçš„é¡¹ç›®åï¼Ÿ

**ç­”**: ä¿®æ”¹ `config.yaml` ä¸­çš„ `project_name`ï¼š

```yaml
production:
  project_name: my-custom-name  # è‡ªå®šä¹‰åç§°
```

---

## ðŸ”’ å®‰å…¨å»ºè®®

1. **ä½¿ç”¨ IAM Role** è€Œä¸æ˜¯é•¿æœŸå‡­è¯
2. **å®šæœŸè½®æ¢** Access Key
3. **å¯ç”¨ MFA** ä¿æŠ¤è´¦å·
4. **ä½¿ç”¨ AWS Organizations** ç®¡ç†å¤šè´¦å·
5. **å¯ç”¨ CloudTrail** å®¡è®¡æ‰€æœ‰æ“ä½œ
6. **é…ç½® AWS Config** ç›‘æŽ§åˆè§„æ€§
7. **ä½¿ç”¨ Secrets Manager** å­˜å‚¨æ•æ„Ÿé…ç½®

---

## ðŸ“š ç›¸å…³æ–‡æ¡£

- [README.md](./README.md) - é¡¹ç›®å®Œæ•´æ–‡æ¡£
- [å®‰å…¨å®¡è®¡æŠ¥å‘Š.md](./å®‰å…¨å®¡è®¡æŠ¥å‘Š.md) - å®‰å…¨å®¡è®¡è¯¦æƒ…
- [config.yaml](./config.yaml) - é…ç½®æ–‡ä»¶ç¤ºä¾‹

---

**æœ€åŽæ›´æ–°**: 2025-01-27  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
