# MinerU ECS - 高性能PDF智能处理服务

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![AWS](https://img.shields.io/badge/AWS-ECS-orange.svg)](https://aws.amazon.com/ecs/)
[![GPU](https://img.shields.io/badge/GPU-Tesla%20T4-green.svg)](https://www.nvidia.com/en-us/data-center/tesla-t4/)
[![Python](https://img.shields.io/badge/Python-3.10-blue.svg)](https://www.python.org/)

基于 AWS ECS 的企业级 PDF 文档智能处理服务，使用 MinerU AI 引擎和 GPU 加速，实现高性能文档解析。

---

## 📋 目录

- [项目概述](#-项目概述)
- [核心功能](#-核心功能)
- [系统架构](#-系统架构)
- [快速开始](#-快速开始)
- [部署指南](#-部署指南)
- [使用说明](#-使用说明)
- [配置管理](#-配置管理)
- [监控运维](#-监控运维)
- [性能指标](#-性能指标)
- [故障排除](#-故障排除)
- [开发指南](#-开发指南)

---

## 🚀 项目概述

MinerU ECS 是一个云原生的 PDF 文档智能处理系统，提供：

### 核心特性

✅ **GPU 加速处理** - 使用 NVIDIA Tesla T4 GPU，处理速度提升 10 倍  
✅ **智能文档解析** - 基于 MinerU AI 引擎，支持复杂文档结构识别  
✅ **多格式输出** - 生成 Markdown、JSON、图片等多种格式  
✅ **云原生架构** - 基于 AWS ECS 容器化部署，支持自动扩缩容  
✅ **事件驱动** - S3 上传自动触发处理，无需手动干预  
✅ **企业级可靠性** - 99.9% 可用性，完整的监控和日志系统

### 技术栈

| 组件 | 技术 | 版本 |
|------|------|------|
| **AI 引擎** | MinerU | 2.1.0 |
| **GPU** | NVIDIA Tesla T4 | 16GB VRAM |
| **深度学习** | PyTorch + CUDA | 2.7.1 + 12.4 |
| **容器** | Docker | - |
| **编排** | AWS ECS | - |
| **存储** | S3 + DynamoDB | - |
| **消息队列** | SQS | - |
| **监控** | CloudWatch + Prometheus | - |

---

## 💡 核心功能

### 1. PDF 智能解析

**支持的文档类型**:
- 文本密集型文档（报告、论文）
- 图表密集型文档（数据报表）
- 混合型文档（技术手册）
- 扫描文档（OCR 识别）

**输出格式**:
- **Markdown** - 结构化文本，保留标题层级
- **JSON** - 完整的文档结构数据
- **图片** - 提取的图表和图像
- **元数据** - 页数、处理时间等信息

### 2. GPU 加速

**性能对比**:

| 文档类型 | 页数 | GPU 处理时间 | CPU 处理时间 | 加速比 |
|---------|------|-------------|-------------|--------|
| 简单文档 | 10页 | 30秒 | 5分钟 | **10x** |
| 复杂文档 | 32页 | 1.7分钟 | 17分钟 | **10x** |
| 图表密集 | 50页 | 3分钟 | 30分钟 | **10x** |

### 3. 自动化处理流程

```
用户上传 PDF → S3 触发 → Lambda 创建任务 → SQS 队列 
    → ECS 容器接收 → GPU 处理 → 结果上传 S3 → 状态更新
```

**处理时间线**（32页文档示例）:
- 队列等待: 4.5秒
- 文件下载: 0.1秒
- GPU 处理: 104秒
- 结果上传: 2.3秒
- **总计**: 约 1.8 分钟

---

## 🏗️ 系统架构

### 整体架构图

```
┌──────────────────────────────────────────────────────────────┐
│                         用户层                                │
│                    (上传 PDF 文件)                            │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│                        存储层                                 │
│  S3 存储桶: mineru-ecs-production-data-{account-id}          │
│  ├── input/          (输入 PDF 文件)                         │
│  └── processed/      (处理结果)                              │
└──────────────────────────────────────────────────────────────┘
                              ↓ (S3 事件)
┌──────────────────────────────────────────────────────────────┐
│                       触发层                                  │
│  Lambda 函数 → 创建 SQS 消息 + DynamoDB 任务记录             │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│                       消息层                                  │
│  SQS 队列 (长轮询 20秒) + 死信队列 (失败重试)                │
└──────────────────────────────────────────────────────────────┘
                              ↓ (ECS 轮询)
┌──────────────────────────────────────────────────────────────┐
│                       计算层                                  │
│  ┌────────────────────────────────────────────────────────┐  │
│  │  ECS 集群 (g4dn.xlarge 实例)                           │  │
│  │  ┌──────────────────────────────────────────────────┐  │  │
│  │  │  MinerU 容器 (Docker)                            │  │  │
│  │  │  ├── main.py         (任务调度)                   │  │  │
│  │  │  ├── processor.py    (PDF 处理)                  │  │  │
│  │  │  ├── queue_manager   (队列管理)                   │  │  │
│  │  │  └── job_manager     (状态管理)                   │  │  │
│  │  └──────────────────────────────────────────────────┘  │  │
│  │                        ↓                               │  │
│  │  ┌──────────────────────────────────────────────────┐  │  │
│  │  │  NVIDIA Tesla T4 GPU (16GB VRAM)                 │  │  │
│  │  │  CUDA 12.4 + PyTorch 2.7.1                       │  │  │
│  │  └──────────────────────────────────────────────────┘  │  │
│  └────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│                      数据层                                   │
│  DynamoDB: mineru-ecs-production-processing-jobs             │
│  (任务状态、处理时间、结果元数据)                             │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│                      监控层                                   │
│  CloudWatch 日志 + Prometheus 指标 + 健康检查                │
└──────────────────────────────────────────────────────────────┘
```

### 核心组件

#### 1. 存储层
- **S3 存储桶**: 输入 PDF 和输出结果
- **DynamoDB**: 任务状态和元数据

#### 2. 消息层
- **SQS 主队列**: 任务消息队列（长轮询）
- **SQS 死信队列**: 失败任务处理
- **Lambda 触发器**: S3 事件处理

#### 3. 计算层
- **ECS 集群**: 容器编排
- **GPU 实例**: g4dn.xlarge (Tesla T4)
- **MinerU 容器**: PDF 处理引擎

#### 4. 监控层
- **CloudWatch**: 日志和指标
- **Prometheus**: 自定义指标
- **健康检查**: HTTP 端点

---

## 🚀 快速开始

### 前置条件

- AWS 账户（具有 ECS、S3、DynamoDB 权限）
- AWS CLI 已配置
- Docker 已安装（用于本地测试）

### 一键部署

```bash
# 1. 克隆项目
cd /home/ubuntu/efs/mineru-ecs

# 2. 配置环境（可选，使用默认配置）
cp config.yaml.example config.yaml
vim config.yaml

# 3. 执行部署（生产环境）
./deploy-cross-account.sh --environment production --region us-east-1

# 4. 验证部署
aws ecs describe-clusters --clusters mineru-ecs-production-cluster
aws ecs list-tasks --cluster mineru-ecs-production-cluster
```

### 测试处理

```bash
# 上传测试 PDF
aws s3 cp test.pdf s3://mineru-ecs-production-data-{account-id}/input/

# 查看任务状态
aws dynamodb scan \
  --table-name mineru-ecs-production-processing-jobs \
  --limit 1

# 下载处理结果
aws s3 ls s3://mineru-ecs-production-data-{account-id}/processed/ --recursive
aws s3 sync s3://mineru-ecs-production-data-{account-id}/processed/{job-id}/ ./results/
```

---

# 📦 部署指南

### 部署架构

用分层部个 CloudFormation 栈：

```
01-ecs-infrastructure.yaml    (基础设施层)
  